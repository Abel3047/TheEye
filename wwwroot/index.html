<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Eye Almanac — DM Dashboard</title>
    <style>
        body {
            font-family: system-ui, Arial;
            margin: 12px;
            background: #0b0b0f;
            color: #e6eef8;
        }

        #top {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        #canvas {
            background: #061426;
            border: 1px solid #234;
            margin-top: 12px;
            display: block;
        }

        .panel {
            background: #071827;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 0 12px rgba(0,0,0,0.6);
            min-width: 220px;
        }

        button {
            padding: 6px 8px;
            margin: 4px 0;
        }

        label {
            display: block;
            font-size: 12px;
            color: #9fb7cc;
            margin-top: 4px;
        }

        input[type=number] {
            width: 80px;
        }

        .small {
            font-size: 12px;
            color: #9fb7cc;
        }
    </style>
</head>
<body>
    <h2>The Eye — DM Dashboard</h2>
    <div id="top">
        <div class="panel">
            <div><strong>Eye Metrics</strong></div>
            <div id="metrics">Loading…</div>
            <hr />
            <div>
                <label>Camp coords (km)</label>
                X: <input id="campX" type="number" value="0" step="1" />
                Y: <input id="campY" type="number" value="0" step="1" />
                <button id="calcArrival">Calc ETA</button>
                <div id="eta" class="small"></div>
            </div>
            <hr />
            <div>
                <label>Shrink Eye (instant %)</label>
                <input id="shrinkPercent" type="number" value="20" min="1" max="99" />
                <button id="shrinkBtn">Shrink Now</button>
            </div>
            <div>
                <label>Set Diameter (km)</label>
                <input id="setDiameter" type="number" value="50" min="1" />
                <button id="setDiameterBtn">Set Diameter</button>
            </div>
            <div>
                <label>Shrink over Time</label>
                Target: <input id="shrinkTarget" type="number" value="20" min="1" /> km
                Duration: <input id="shrinkHours" type="number" value="12" min="1" /> h
                <button id="shrinkOverBtn">Start Shrink</button>
            </div>
        </div>

        <div class="panel">
            <div><strong>Controls</strong></div>
            <button id="advanceDay">Advance 1 day</button>
            <button id="pause">Pause</button>
            <button id="resume">Resume</button>
        </div>
    </div>

    <canvas id="canvas" width="800" height="400"></canvas>

    <script>
        const apiRoot = "/Eye";
        let state = null;
        let initializedCamp = false;

        // We want 50 km to fill most of the canvas (90% of smallest dimension)
        const BASE_EYE_DIAMETER = 50.0; // km used to compute initial scale

        async function fetchState() {
            try {
                const r = await fetch(apiRoot);
                if (!r.ok) return;
                state = await r.json();
                render();
                // initialize camp coords to eye center on first load
                if (!initializedCamp) {
                    document.getElementById("campX").value = state.X.toFixed(2);
                    document.getElementById("campY").value = state.Y.toFixed(2);
                    initializedCamp = true;
                }
            } catch (e) { console.error(e); }
        }

        function render() {
            if (!state) return;
            document.getElementById("metrics").innerHTML = `
                    <div>Eye Position: (${state.X.toFixed(1)}, ${state.Y.toFixed(1)}) km</div>
                    <div>Bearing: ${state.BaseBearing.toFixed(1)}°</div>
                    <div>Speed: ${state.SpeedKmPerDay.toFixed(2)} km/day</div>
                    <div><strong>Diameter:</strong> ${state.DiameterKm.toFixed(2)} km</div>
                    <div>Active influences: ${state.ActiveInfluences.length}</div>
                    <div>Last updated: ${new Date(state.LastUpdated).toLocaleTimeString()}</div>
                `;
            drawCanvas();
        }

        function drawCanvas() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // compute scale so BASE_EYE_DIAMETER spans 90% of the smallest canvas dimension
            const minDim = Math.min(canvas.width, canvas.height);
            const desiredPxForBaseDiameter = minDim * 0.9;
            const scale = desiredPxForBaseDiameter / BASE_EYE_DIAMETER; // px per km

            // radius in pixels based on current diameter
            const radiusPx = (state.DiameterKm / 2) * scale;

            // background
            ctx.fillStyle = "#04151f";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // eye circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, Math.max(2, radiusPx), 0, Math.PI * 2);
            ctx.fillStyle = "rgba(200,150,80,0.12)";
            ctx.fill();

            // set line width in proportion to speed, but keep it sane
            const lw = Math.max(1, Math.min(12, state.SpeedKmPerDay / 2.0));
            ctx.lineWidth = lw;
            ctx.strokeStyle = "rgba(200,150,80,0.6)";
            ctx.stroke();

            // eye center
            ctx.beginPath();
            ctx.arc(centerX, centerY, 6, 0, Math.PI * 2);
            ctx.fillStyle = "#ffd880";
            ctx.fill();
            ctx.fillStyle = "#000";
            ctx.font = "12px Arial";
            ctx.fillText("Eye Center", centerX + 10, centerY + 4);

            // bearing arrow
            const rad = (90 - state.BaseBearing) * Math.PI / 180;
            const arrowLen = Math.max(60, radiusPx * 0.5);
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + Math.cos(rad) * arrowLen, centerY + Math.sin(rad) * arrowLen);
            ctx.strokeStyle = "#88c0ff";
            ctx.lineWidth = 2;
            ctx.stroke();

            // camp: convert camp coords (km) to pixel positions relative to eye center
            const campX = parseFloat(document.getElementById("campX").value) || state.X;
            const campY = parseFloat(document.getElementById("campY").value) || state.Y;
            const campPxX = centerX + (campX - state.X) * scale;
            const campPxY = centerY - (campY - state.Y) * scale;

            // draw camp marker
            ctx.fillStyle = "#ff6b6b";
            ctx.beginPath();
            ctx.arc(campPxX, campPxY, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#ffe";
            ctx.font = "13px Arial";
            ctx.fillText("Camp", campPxX + 10, campPxY + 5);

            // optionally draw a faint grid for scale (every 10 km)
            drawScaleGrid(ctx, centerX, centerY, scale, radiusPx);
        }

        function drawScaleGrid(ctx, centerX, centerY, scale, radiusPx) {
            // draw rings every 10 km up to 3 rings or until exceeds canvas
            ctx.save();
            ctx.strokeStyle = "rgba(150,180,200,0.06)";
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 6]);
            for (let km = 10; km <= BASE_EYE_DIAMETER; km += 10) {
                const r = km * scale;
                if (r > Math.max(centerX, centerY) * 2) break;
                ctx.beginPath();
                ctx.arc(centerX, centerY, r, 0, Math.PI * 2);
                ctx.stroke();
                ctx.fillStyle = "rgba(180,200,220,0.08)";
                ctx.font = "11px Arial";
                ctx.fillText(`${km} km`, centerX + r + 6, centerY);
            }
            ctx.restore();
        }

        // ---- button hooks ----
        document.getElementById("advanceDay").addEventListener("click", async () => {
            await fetch("/Eye/advance", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ hours: 24 }) });
            await fetchState();
        });
        document.getElementById("pause").addEventListener("click", async () => {
            await fetch("/Eye/pause", { method: "POST" });
            await fetchState();
        });
        document.getElementById("resume").addEventListener("click", async () => {
            await fetch("/Eye/resume", { method: "POST" });
            await fetchState();
        });
        document.getElementById("calcArrival").addEventListener("click", () => {
            if (!state) return;
            const campX = parseFloat(document.getElementById("campX").value) || 0;
            const campY = parseFloat(document.getElementById("campY").value) || 0;
            const dx = campX - state.X;
            const dy = campY - state.Y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const edgeDist = Math.max(0, dist - state.DiameterKm / 2.0);
            const days = edgeDist / state.SpeedKmPerDay;
            document.getElementById("eta").innerText =
                `Edge distance: ${edgeDist.toFixed(1)} km ≈ ${Math.max(0, days).toFixed(2)} days`;
        });

        document.getElementById("shrinkBtn").addEventListener("click", async () => {
            const pct = parseFloat(document.getElementById("shrinkPercent").value) || 10;
            await fetch("/Eye/shrink", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ percent: pct }) });
            await fetchState();
        });

        document.getElementById("setDiameterBtn").addEventListener("click", async () => {
            const d = parseFloat(document.getElementById("setDiameter").value) || 50;
            await fetch("/Eye/setDiameter", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ diameterKm: d }) });
            await fetchState();
        });

        document.getElementById("shrinkOverBtn").addEventListener("click", async () => {
            const target = parseFloat(document.getElementById("shrinkTarget").value) || 20;
            const hours = parseInt(document.getElementById("shrinkHours").value) || 12;
            await fetch("/Eye/shrink-over-time", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ targetDiameterKm: target, durationHours: hours }) });
            await fetchState();
        });

        // polling
        setInterval(fetchState, 2000);
        fetchState();
    </script>
</body>
</html>
