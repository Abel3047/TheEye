<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Eye Almanac — DM Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
        :root {
            --panel-bg: #071827;
            --accent: #ffd880;
            --muted: #9fb7cc;
            --bg: #0b0b0f;
        }

        body {
            font-family: system-ui, Arial;
            margin: 12px;
            background: var(--bg);
            color: #e6eef8;
        }

        h2 {
            margin: 0 0 10px 0;
        }

        #wrap {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .panel {
            background: var(--panel-bg);
            padding: 12px;
            border-radius: 8px;
            min-width: 240px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.6);
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px;
        }

        input[type=number], input[type=text] {
            width: 100px;
            padding: 6px;
            margin-right: 8px;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.06);
            background: #0f222b;
            color: #e6eef8;
        }

        button {
            padding: 8px 10px;
            margin: 6px 4px 0 0;
            border-radius: 6px;
            background: #163247;
            color: #e6eef8;
            border: 0;
            cursor: pointer;
        }

            button.secondary {
                background: #0b2a2f;
            }

        .small {
            font-size: 12px;
            color: var(--muted);
            margin-top: 6px;
        }

        #canvas {
            border-radius: 6px;
            display: block;
            background: #061426;
            border: 1px solid #234;
            margin-top: 12px;
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .muted {
            color: var(--muted);
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h2>The Eye — DM Dashboard</h2>

    <div id="wrap">
        <div class="panel" id="controls">
            <div><strong>Eye Metrics</strong></div>
            <div id="metrics" class="small">loading…</div>

            <label>Camp coords (km)</label>
            <div class="row">
                X: <input id="campX" type="number" value="0" step="0.1" />
                Y: <input id="campY" type="number" value="0" step="0.1" />
                <button id="centerCamp">Center on Eye</button>
            </div>
            <div class="small" id="eta">ETA: —</div>

            <hr style="border: none; height:1px; background:#0e3244; margin:10px 0;" />

            <div><strong>Diameter</strong></div>
            <div class="row">
                <label style="margin:6px 0 0 0;">Set Diameter (km)</label>
                <input id="setDiameter" type="number" value="50" min="1" />
                <button id="setDiameterBtn">Set</button>
            </div>
            <div class="row" style="margin-top:6px;">
                <label style="margin:0 8px 0 0;">Shrink over time</label>
                Target: <input id="shrinkTarget" type="number" value="30" min="1" />
                Hours: <input id="shrinkHours" type="number" value="12" min="1" style="width:64px" />
                <button id="shrinkOverBtn">Start</button>
            </div>
            <div class="row" style="margin-top:8px;">
                <label style="margin:0 8px 0 0;">Instant shrink %</label>
                <input id="shrinkPercent" type="number" value="10" min="1" max="99" />
                <button id="shrinkNow">Shrink</button>
            </div>

            <hr style="border: none; height:1px; background:#0e3244; margin:10px 0;" />

            <div><strong>Time & Influence</strong></div>
            <div class="row">
                <label>Advance days</label>
                <input id="jumpDays" type="number" value="1" min="1" />
                <button id="jumpDaysBtn">Jump</button>
                <button id="advanceDay">+1 day</button>
            </div>

            <div style="margin-top:8px;"><strong>Influence (wind / push)</strong></div>
            <div class="row">
                <input id="infName" type="text" placeholder="name (optional)" />
                <input id="infDir" type="number" placeholder="deg" value="90" style="width:64px" />
                <input id="infMag" type="number" placeholder="km/day" value="5" style="width:80px" />
                <input id="infDur" type="number" placeholder="hours" value="72" style="width:80px" />
                <button id="applyInf">Apply</button>
            </div>

            <hr style="border: none; height:1px; background:#0e3244; margin:10px 0;" />

            <div><strong>Base / Surge / Ops</strong></div>
            <div class="row">
                <label>Set base (bearing°, km/day)</label>
                <input id="baseBearing" type="number" value="90" style="width:80px" />
                <input id="baseSpeed" type="number" value="12" style="width:80px" />
                <button id="setBase">Set</button>
            </div>
            <div class="row" style="margin-top:6px;">
                <label>Surge</label>
                Factor: <input id="surgeFactor" type="number" value="2" style="width:64px" />
                Hours: <input id="surgeHours" type="number" value="6" style="width:64px" />
                <button id="surgeBtn">Trigger</button>
            </div>

            <hr style="border: none; height:1px; background:#0e3244; margin:10px 0;" />

            <div class="row">
                <button id="pause">Pause</button>
                <button id="resume">Resume</button>
                <button id="resetBtn" class="secondary">Reset</button>
            </div>

            <div class="small" style="margin-top:8px;">
                Trail length: <span id="trailLen">60</span> • Poll: <span id="pollMs">2000</span> ms
            </div>
            <div class="small" id="lastLog"></div>
        </div>

        <div style="flex:1;">
            <canvas id="canvas" width="1000" height="600"></canvas>
            <div class="small muted" style="margin-top:6px;">Camp is fixed in the center. Eye moves relative to camp. Trail shows last positions (fading).</div>
        </div>
    </div>

    <script>
        /* ====== Configuration ====== */
        const API_ROOT = "/Eye";
        const POLL_MS = 2000;                 // poll frequency (ms)
        const TRAIL_MAX = 60;                 // how many past points to keep
        const BASE_EYE_DIAMETER = 50.0;       // km used to map scale
        const BASE_EYE_COVER = 0.85;          // proportion of smallest canvas dim for base diameter (85%)
        /* =========================== */

        let state = null;
        let prevState = null;
        let trail = []; // array of {t: timestamp, X, Y, DiameterKm}
        let initializedCamp = false;

        // UI elements
        const canvas = document.getElementById("canvas");
        const ctx = canvas.getContext("2d");
        const campXInput = document.getElementById("campX");
        const campYInput = document.getElementById("campY");
        document.getElementById("trailLen").innerText = TRAIL_MAX;
        document.getElementById("pollMs").innerText = POLL_MS;

        function safeFetch(url, opts) {
            return fetch(url, opts).then(r => {
                if (!r.ok) throw new Error(`HTTP ${r.status}`);
                return r.json();
            });
        }

        async function getState() {
            try {
                const s = await safeFetch(API_ROOT);
                return s;
            } catch (e) {
                console.error("Failed to fetch /Eye", e);
                return null;
            }
        }

        async function fetchState() {
            const newState = await getState();
            if (!newState) return;
            // shift prev->state
            prevState = state ? { ...state } : null;
            state = newState;

            // initialize camp to eye center on first load
            if (!initializedCamp) {
                campXInput.value = state.X.toFixed(3);
                campYInput.value = state.Y.toFixed(3);
                initializedCamp = true;
            }

            // Append a trail point (use the state snapshot)
            trail.push({ t: Date.now(), X: state.X, Y: state.Y, DiameterKm: state.DiameterKm });
            if (trail.length > TRAIL_MAX) trail.shift();

            // animate between prevState -> state over POLL_MS
            animateBetween(prevState, state, POLL_MS);

            // update metrics/logs
            document.getElementById("lastLog").innerText = `Last polled: ${new Date().toLocaleTimeString()}`;
        }

        function animateBetween(a, b, durationMs) {
            // if no previous state, just render current
            if (!a) {
                render(b);
                return;
            }
            const start = performance.now();
            function frame(now) {
                const t = Math.min(1, (now - start) / durationMs);
                const tmp = {
                    X: lerp(a.X, b.X, t),
                    Y: lerp(a.Y, b.Y, t),
                    DiameterKm: lerp(a.DiameterKm, b.DiameterKm, t),
                    BaseBearing: lerp(a.BaseBearing, b.BaseBearing, t),
                    SpeedKmPerDay: lerp(a.SpeedKmPerDay, b.SpeedKmPerDay, t),
                    ActiveInfluences: b.ActiveInfluences,
                    LastUpdated: b.LastUpdated
                };
                render(tmp);
                if (t < 1) requestAnimationFrame(frame);
            }
            requestAnimationFrame(frame);
        }

        function lerp(a, b, t) { return a + (b - a) * t; }

        function render(s) {
            const snap = s || state;
            if (!snap) return;
            // metrics
            document.getElementById("metrics").innerHTML = `
        <div class="muted">Eye Pos: (${snap.X.toFixed(3)}, ${snap.Y.toFixed(3)}) km</div>
        <div class="muted">Bearing: ${snap.BaseBearing.toFixed(1)}° • Speed: ${snap.SpeedKmPerDay.toFixed(2)} km/day</div>
        <div><strong>Diameter:</strong> ${snap.DiameterKm.toFixed(2)} km</div>
        <div class="muted">Influences: ${snap.ActiveInfluences.length} • Last: ${new Date(snap.LastUpdated).toLocaleTimeString()}</div>
      `;
            drawCanvas(snap);
        }

        function drawCanvas(snap) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // center of viewport = camp
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;

            // scale: map BASE_EYE_DIAMETER -> BASE_EYE_COVER * minDim px
            const minDim = Math.min(canvas.width, canvas.height);
            const desiredPx = minDim * BASE_EYE_COVER;
            const pxPerKm = desiredPx / BASE_EYE_DIAMETER;

            // camp coords in world (from inputs)
            const campX = parseFloat(campXInput.value) || snap.X;
            const campY = parseFloat(campYInput.value) || snap.Y;

            // draw faint background
            ctx.fillStyle = "#04151f";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // draw trail (older first)
            for (let i = 0; i < trail.length; i++) {
                const p = trail[i];
                const ageFactor = i / trail.length; // 0..1
                const opacity = (0.15 + 0.85 * (ageFactor)); // older = darker or lighter? we'll fade oldest more
                const tx = cx + (p.X - campX) * pxPerKm;
                const ty = cy - (p.Y - campY) * pxPerKm;
                const tr = Math.max(1, (p.DiameterKm / 2) * pxPerKm);
                ctx.beginPath();
                ctx.arc(tx, ty, tr, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(200,150,80,${0.06 * (ageFactor + 0.2)})`;
                ctx.fill();
                ctx.strokeStyle = `rgba(200,150,80,${0.06 * (ageFactor + 0.6)})`;
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // draw current Eye (snap)
            const eyeX = cx + (snap.X - campX) * pxPerKm;
            const eyeY = cy - (snap.Y - campY) * pxPerKm;
            const radius = Math.max(2, (snap.DiameterKm / 2) * pxPerKm);

            // Eye fill
            ctx.beginPath();
            ctx.arc(eyeX, eyeY, radius, 0, Math.PI * 2);
            ctx.fillStyle = "rgba(200,150,80,0.12)";
            ctx.fill();
            // Eye outline
            ctx.lineWidth = Math.max(1, Math.min(14, snap.SpeedKmPerDay / 1.5));
            ctx.strokeStyle = "rgba(200,150,80,0.7)";
            ctx.stroke();

            // Eye center marker
            ctx.beginPath();
            ctx.arc(eyeX, eyeY, 6, 0, Math.PI * 2);
            ctx.fillStyle = "#ffd880";
            ctx.fill();
            ctx.fillStyle = "#000";
            ctx.font = "12px Arial";
            ctx.fillText("Eye Center", eyeX + 10, eyeY + 4);

            // bearing arrow
            const rad = (90 - snap.BaseBearing) * Math.PI / 180;
            const arrowLen = Math.max(40, radius * 0.45);
            ctx.beginPath();
            ctx.moveTo(eyeX, eyeY);
            ctx.lineTo(eyeX + Math.cos(rad) * arrowLen, eyeY + Math.sin(rad) * arrowLen);
            ctx.strokeStyle = "#88c0ff";
            ctx.lineWidth = 2;
            ctx.stroke();

            // camp marker at center of viewport
            ctx.beginPath();
            ctx.arc(cx, cy, 8, 0, Math.PI * 2);
            ctx.fillStyle = "#ff6b6b";
            ctx.fill();
            ctx.fillStyle = "#ffe";
            ctx.font = "13px Arial";
            ctx.fillText("Camp (you)", cx + 12, cy + 5);

            // debug delta text (pixel delta from previous)
            if (prevState) {
                const prevPxX = cx + (prevState.X - campX) * pxPerKm;
                const prevPxY = cy - (prevState.Y - campY) * pxPerKm;
                const dxPx = (eyeX - prevPxX).toFixed(3);
                const dyPx = (eyeY - prevPxY).toFixed(3);
                ctx.fillStyle = "#9fb7cc";
                ctx.font = "12px Arial";
                ctx.fillText(`Δpx: ${dxPx}, ${dyPx}`, 10, canvas.height - 12);
            }
        }

        /* ========== Button Handlers (wired to your endpoints) ========== */

        document.getElementById("centerCamp").addEventListener("click", () => {
            if (!state) return;
            campXInput.value = state.X.toFixed(3);
            campYInput.value = state.Y.toFixed(3);
            render();
        });

        document.getElementById("setDiameterBtn").addEventListener("click", async () => {
            const d = parseFloat(document.getElementById("setDiameter").value) || 50;
            await safePost(`${API_ROOT}/setDiameter`, { DiameterKm: d });
            await fetchState();
        });

        document.getElementById("shrinkOverBtn").addEventListener("click", async () => {
            const target = parseFloat(document.getElementById("shrinkTarget").value) || 30;
            const hours = parseInt(document.getElementById("shrinkHours").value) || 12;
            await safePost(`${API_ROOT}/shrink-over-time`, { TargetDiameterKm: target, DurationHours: hours });
            await fetchState();
        });

        document.getElementById("shrinkNow").addEventListener("click", async () => {
            const pct = parseFloat(document.getElementById("shrinkPercent").value) || 10;
            // instant shrink implemented by ShrinkByPercent endpoint previously; there is /Eye/shrink in older API.
            // We'll mimic by computing target diameter and calling setDiameter (read current first)
            if (!state) await fetchState();
            const cur = state.DiameterKm;
            const target = Math.max(0.1, cur * (1 - pct / 100));
            await safePost(`${API_ROOT}/setDiameter`, { DiameterKm: target });
            await fetchState();
        });

        document.getElementById("advanceDay").addEventListener("click", async () => {
            await safePost(`${API_ROOT}/advance`, { Hours: 24 });
            await fetchState();
        });

        document.getElementById("jumpDaysBtn").addEventListener("click", async () => {
            const days = parseFloat(document.getElementById("jumpDays").value) || 1;
            await safePost(`${API_ROOT}/jumpDays`, { Days: days });
            await fetchState();
        });

        document.getElementById("applyInf").addEventListener("click", async () => {
            const name = document.getElementById("infName").value || undefined;
            const dir = parseFloat(document.getElementById("infDir").value) || 0;
            const mag = parseFloat(document.getElementById("infMag").value) || 1;
            const dur = parseFloat(document.getElementById("infDur").value) || 24;
            await safePost(`${API_ROOT}/applyInfluence`, { Name: name, DirectionDeg: dir, MagnitudeKmPerDay: mag, DurationHours: dur });
            await fetchState();
        });

        document.getElementById("setBase").addEventListener("click", async () => {
            const bearing = parseFloat(document.getElementById("baseBearing").value) || 90;
            const speed = parseFloat(document.getElementById("baseSpeed").value) || 12;
            await safePost(`${API_ROOT}/setBase`, { BearingDeg: bearing, SpeedKmPerDay: speed });
            await fetchState();
        });

        document.getElementById("surgeBtn").addEventListener("click", async () => {
            const factor = parseFloat(document.getElementById("surgeFactor").value) || 2;
            const hours = parseFloat(document.getElementById("surgeHours").value) || 6;
            await safePost(`${API_ROOT}/surge`, { Factor: factor, DurationHours: hours, Name: "dash" });
            await fetchState();
        });

        document.getElementById("pause").addEventListener("click", async () => {
            await safePost(`${API_ROOT}/pause`, {});
            await fetchState();
        });
        document.getElementById("resume").addEventListener("click", async () => {
            await safePost(`${API_ROOT}/resume`, {});
            await fetchState();
        });

        document.getElementById("resetBtn").addEventListener("click", async () => {
            const payload = {
                X: parseFloat(campXInput.value) || 0,
                Y: parseFloat(campYInput.value) || 0,
                BaseBearing: parseFloat(document.getElementById("baseBearing").value) || 90,
                SpeedKmPerDay: parseFloat(document.getElementById("baseSpeed").value) || 12,
                DriftVarianceDeg: 5.0,
                JitterFraction: 0.08,
                CourseShiftChancePerDay: 0.03,
                PredictabilityRating: 3
            };
            await safePost(`${API_ROOT}/reset`, payload);
            await fetchState();
        });

        /* ===== HTTP helper wrappers ===== */
        async function safePost(url, body) {
            try {
                const r = await fetch(url, { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify(body) });
                if (!r.ok) {
                    const txt = await r.text();
                    console.error("POST failed", r.status, txt);
                    alert("Server error: " + r.status + (txt ? ("\n" + txt) : ""));
                } else {
                    return await r.json();
                }
            } catch (e) {
                console.error("Network POST failed", e);
            }
        }

        /* ===== Polling loop ===== */
        setInterval(fetchState, POLL_MS);
        fetchState(); // initial

    </script>
</body>
</html>
