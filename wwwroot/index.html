<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Eye Almanac — DM Dashboard</title>
    <style>
        body {
            font-family: system-ui, Arial;
            margin: 12px;
            background: #0b0b0f;
            color: #e6eef8;
        }

        #top {
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        #canvas {
            background: #061426;
            border: 1px solid #234;
            margin-top: 12px;
        }

        .panel {
            background: #071827;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 0 12px rgba(0,0,0,0.6);
            min-width: 220px;
        }

        button {
            padding: 6px 8px;
            margin: 4px 0;
        }

        label {
            display: block;
            font-size: 12px;
            color: #9fb7cc;
            margin-top: 4px;
        }

        input[type=number] {
            width: 80px;
        }
    </style>
</head>
<body>
    <h2>The Eye — DM Dashboard</h2>
    <div id="top">
        <div class="panel">
            <div><strong>Eye Metrics</strong></div>
            <div id="metrics">Loading…</div>
            <hr />
            <div>
                <label>Camp coords (km)</label>
                X: <input id="campX" type="number" value="100" step="1" />
                Y: <input id="campY" type="number" value="0" step="1" />
                <button id="calcArrival">Calc ETA</button>
                <div id="eta"></div>
            </div>
            <hr />
            <div>
                <label>Shrink Eye (instant %)</label>
                <input id="shrinkPercent" type="number" value="20" min="1" max="99" />
                <button id="shrinkBtn">Shrink Now</button>
            </div>
            <div>
                <label>Set Diameter (km)</label>
                <input id="setDiameter" type="number" value="50" min="1" />
                <button id="setDiameterBtn">Set Diameter</button>
            </div>
            <div>
                <label>Shrink over Time</label>
                Target: <input id="shrinkTarget" type="number" value="20" min="1" /> km
                Duration: <input id="shrinkHours" type="number" value="12" min="1" /> h
                <button id="shrinkOverBtn">Start Shrink</button>
            </div>
        </div>

        <div class="panel">
            <div><strong>Controls</strong></div>
            <button id="advanceDay">Advance 1 day</button>
            <button id="pause">Pause</button>
            <button id="resume">Resume</button>
        </div>
    </div>

    <canvas id="canvas" width="800" height="400"></canvas>

    <script>
        const apiRoot = "/Eye";
        let state = null;

        async function fetchState() {
            try {
                const r = await fetch(apiRoot);
                if (!r.ok) return;
                state = await r.json();
                render();
            } catch (e) { console.error(e); }
        }

        function render() {
            if (!state) return;
            document.getElementById("metrics").innerHTML = `
        <div>Eye Position: (${state.X.toFixed(1)}, ${state.Y.toFixed(1)}) km</div>
        <div>Bearing: ${state.BaseBearing.toFixed(1)}°</div>
        <div>Speed: ${state.SpeedKmPerDay.toFixed(2)} km/day</div>
        <div><strong>Diameter:</strong> ${state.DiameterKm.toFixed(2)} km</div>
        <div>Active influences: ${state.ActiveInfluences.length}</div>
        <div>Last updated: ${new Date(state.LastUpdated).toLocaleTimeString()}</div>
      `;
            drawCanvas();
        }

        function drawCanvas() {
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const scale = 2.0; // km → px
            const radiusPx = (state.DiameterKm / 2) * scale;

            // background
            ctx.fillStyle = "#04151f";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Eye circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, Math.max(2, radiusPx), 0, Math.PI * 2);
            ctx.fillStyle = "rgba(200,150,80,0.12)";
            ctx.fill();
            ctx.lineWidth = state.SpeedKmPerDay.toFixed(2)/10 };
            ctx.strokeStyle = "rgba(200,150,80,0.5)";
            ctx.stroke();

            // Eye center
            ctx.beginPath();
            ctx.arc(centerX, centerY, 4, 0, Math.PI * 2);
            ctx.fillStyle = "#ffd880";
            ctx.fill();

            // bearing arrow
            const rad = (90 - state.BaseBearing) * Math.PI / 180;
            const arrowLen = 80;
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + Math.cos(rad) * arrowLen, centerY + Math.sin(rad) * arrowLen);
            ctx.strokeStyle = "#88c0ff";
            ctx.lineWidth = 2;
            ctx.stroke();

            // camp
            const campX = parseFloat(document.getElementById("campX").value) || 0;
            const campY = parseFloat(document.getElementById("campY").value) || 0;
            const campPxX = centerX + (campX - state.X) * scale;
            const campPxY = centerY - (campY - state.Y) * scale;
            ctx.fillStyle = "#ff6b6b";
            ctx.beginPath();
            ctx.arc(campPxX, campPxY, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = "#ffe";
            ctx.fillText("Camp", campPxX + 8, campPxY + 4);
        }

        // ---- button hooks ----
        document.getElementById("advanceDay").addEventListener("click", async () => {
            await fetch("/Eye/advance", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ hours: 24 }) });
            await fetchState();
        });
        document.getElementById("pause").addEventListener("click", async () => {
            await fetch("/Eye/pause", { method: "POST" });
            await fetchState();
        });
        document.getElementById("resume").addEventListener("click", async () => {
            await fetch("/Eye/resume", { method: "POST" });
            await fetchState();
        });
        document.getElementById("calcArrival").addEventListener("click", () => {
            const campX = parseFloat(document.getElementById("campX").value) || 0;
            const campY = parseFloat(document.getElementById("campY").value) || 0;
            const dx = campX - state.X;
            const dy = campY - state.Y;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const edgeDist = Math.max(0, dist - state.DiameterKm / 2.0);
            const days = edgeDist / state.SpeedKmPerDay;
            document.getElementById("eta").innerText =
                `Edge distance: ${edgeDist.toFixed(1)} km ≈ ${Math.max(0, days).toFixed(2)} days`;
        });
        document.getElementById("setDiameterBtn").addEventListener("click", async () => {
            const d = parseFloat(document.getElementById("setDiameter").value) || 50;
            await fetch("/Eye/setDiameter", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ diameterKm: d }) });
            await fetchState();
        });
        document.getElementById("shrinkOverBtn").addEventListener("click", async () => {
            const target = parseFloat(document.getElementById("shrinkTarget").value) || 20;
            const hours = parseInt(document.getElementById("shrinkHours").value) || 12;
            await fetch("/Eye/shrink-over-time", { method: "POST", headers: { "content-type": "application/json" }, body: JSON.stringify({ targetDiameterKm: target, durationHours: hours }) });
            await fetchState();
        });

        // polling
        setInterval(fetchState, 2000);
        fetchState();
    </script>
</body>
</html>
